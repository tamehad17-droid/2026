# ๐ง ุฏููู ุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช - PromoHive

## โก ุงููุดุงูู ุงูุชู ุณูุชู ุญููุง:

1. โ ุฅุตูุงุญ ุงูุจูุงูุงุช ุงูููููุฉ ูู ุตูุญุฉ ุงูุฃุฏูู - ุชู ุจุงููุนู ูู ุงูููุฏ
2. โ ุฅุตูุงุญ ุนุฏู ูุตูู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุจุฑูุฒ ุงูุชุญูู
3. โ ุฅูุดุงุก ูุธุงุฆู ุงูุชุญูู ุงูููููุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
4. โ ุฅุตูุงุญ ุณูุงุณุงุช RLS (Row Level Security)
5. โ ุฅุตูุงุญ ูุธุงุฆู ุงูููุงููุฉ ูุงูุฑูุถ ูููุณุชุฎุฏููู

---

## ๐ ุงูุฎุทูุงุช ุงููุทููุจุฉ:

### ุงูุฎุทูุฉ 1๏ธโฃ: ุชุดุบูู ุณูุฑูุจุช SQL ุงูุฑุฆูุณู

1. **ุงูุชุญ Supabase SQL Editor:**
   ```
   https://supabase.com/dashboard/project/jtxmijnxrgcwjvtdlgxy/sql/new
   ```

2. **ุงูุณุฎ ูุญุชูู ุงูููู ุงูุชุงูู ุจุงููุงูู:**
   ```
   FIX_ALL_DATABASE_ISSUES.sql
   ```

3. **ุงูุตู ุงูุณูุฑูุจุช ูู SQL Editor**

4. **ุงุถุบุท "Run" ุฃู Ctrl+Enter**

5. **ุชุญูู ูู ุงููุชุงุฆุฌ:**
   ูุฌุจ ุฃู ุชุฑู ุฑุณุงุฆู ุงููุฌุงุญ ูู ุงูุฃุณูู:
   ```
   โ DATABASE FIXES COMPLETED SUCCESSFULLY!
   โ All functions created/updated
   โ RLS policies fixed
   โ Permissions granted
   ```

---

### ุงูุฎุทูุฉ 2๏ธโฃ: ุฅุนุฏุงุฏ RESEND API ููุจุฑูุฏ ุงูุฅููุชุฑููู

**ููู ุฌุฏุงู:** ููู ุชุนูู ุฑุณุงุฆู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ุฑูุฒ ุงูุชุญููุ ุงูุจุฑูุฏ ุงูุชุฑุญูุจู)

#### ุฃ) ุงูุญุตูู ุนูู API Key ูู Resend:

1. **ุณุฌู ูู Resend (ูุฌุงูุงู):**
   ```
   https://resend.com/signup
   ```

2. **ุงุญุตู ุนูู API Key:**
   ```
   https://resend.com/api-keys
   โ Create API Key
   โ Name: PromoHive
   โ Type: Sending access
   โ ุงูุณุฎ ุงูููุชุงุญ (ูุจุฏุฃ ุจู re_)
   ```

#### ุจ) ุฅุถุงูุฉ API Key ูู Supabase:

1. **ุงูุชุญ Edge Functions Settings:**
   ```
   https://supabase.com/dashboard/project/jtxmijnxrgcwjvtdlgxy/settings/functions
   ```

2. **ุงุฐูุจ ููุณู "Secrets"**

3. **ุฃุถู Secret ุฌุฏูุฏ:**
   ```
   Name: RESEND_API_KEY
   Value: [ุงูุตู ุงูููุชุงุญ ุงูุฐู ูุณุฎุชู ูู Resend]
   ```

4. **ุงุญูุธ ุงูุชุบููุฑุงุช**

---

### ุงูุฎุทูุฉ 3๏ธโฃ: ุฑูุน Edge Functions

**ุชุญุชุงุฌ ุฅูู ุฑูุน ูุธููุฉ ุฅุฑุณุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:**

#### ุงูุทุฑููุฉ 1: ุนุจุฑ Supabase Dashboard (ุงูุฃุณูู)

1. **ุงูุชุญ Functions:**
   ```
   https://supabase.com/dashboard/project/jtxmijnxrgcwjvtdlgxy/functions
   ```

2. **ุชุญูู ูู ูุฌูุฏ `send-notification-email`**
   - ุฅุฐุง ูุงูุช ููุฌูุฏุฉ: ุชุฃูุฏ ุฃููุง "Active"
   - ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ: ุงูุชูู ููุทุฑููุฉ 2

#### ุงูุทุฑููุฉ 2: ุนุจุฑ Supabase CLI

```bash
# 1. ุชุณุฌูู ุงูุฏุฎูู
supabase login

# 2. ุฑุจุท ุงููุดุฑูุน
supabase link --project-ref jtxmijnxrgcwjvtdlgxy

# 3. ุฑูุน ุงูู Edge Functions
supabase functions deploy send-notification-email

# 4. ุชุญุฏูุซ ุงูู Secrets
supabase secrets set RESEND_API_KEY=your_api_key_here
```

---

### ุงูุฎุทูุฉ 4๏ธโฃ: ุงุฎุชุจุงุฑ ุงููุธุงู

#### ุฃ) ุงุฎุชุจุงุฑ ูุธุงุฆู ูุงุนุฏุฉ ุงูุจูุงูุงุช:

ุงูุชุญ SQL Editor ูุฌุฑุจ:

```sql
-- 1. ุงูุชุญูู ูู ูุฌูุฏ ุงููุธุงุฆู
SELECT routine_name 
FROM information_schema.routines
WHERE routine_schema = 'public'
AND routine_name IN (
    'approve_user',
    'reject_user',
    'create_verification_code',
    'verify_email_code'
);

-- 2. ุงุฎุชุจุงุฑ ุฅูุดุงุก ุฑูุฒ ุชุญูู (ุงุณุชุจุฏู ุงูููู)
SELECT create_verification_code('test@example.com', 'user-uuid-here');

-- 3. ุนุฑุถ ุณูุงุณุงุช RLS
SELECT tablename, policyname 
FROM pg_policies 
WHERE schemaname = 'public'
AND tablename IN ('email_verification_codes', 'user_profiles');
```

#### ุจ) ุงุฎุชุจุงุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:

1. **ุงูุชุญ Functions ูู Dashboard**
2. **ุงุฎุชุฑ `send-notification-email`**
3. **ุงุถุบุท "Invoke"**
4. **ุงุณุชุฎุฏู ูุฐุง ุงูู payload:**

```json
{
  "type": "welcome",
  "to": "your-test-email@gmail.com",
  "data": {
    "fullName": "Test User",
    "loginUrl": "https://promohive.com/login"
  }
}
```

5. **ูุฌุจ ุฃู ูุตูู ุจุฑูุฏ ุชุฑุญูุจู**

#### ุฌ) ุงุฎุชุจุงุฑ ุงูุชุทุจูู:

```bash
# 1. ุดุบู ุงูุชุทุจูู
cd /workspace/promohive
npm install
npm run dev

# 2. ุงูุชุญ ุงููุชุตูุญ
# http://localhost:5173

# 3. ุณุฌู ุญุณุงุจ ุฌุฏูุฏ
# 4. ุงูุชุญ ุตูุญุฉ ุงูุฃุฏูู (ุจุญุณุงุจ ุฃุฏูู)
# 5. ูุงูู ุนูู ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ
# 6. ุชุญูู ูู ูุตูู ุงูุจุฑูุฏ ุงูุชุฑุญูุจู
```

---

## ๐ฏ ููุฎุต ุงูุชุบููุฑุงุช:

### ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
- โ ุฅูุดุงุก ุฌุฏูู `email_verification_codes`
- โ ุฅุถุงูุฉ ุฃุนูุฏุฉ ุงูุชุญูู ูู `user_profiles`
- โ ุฅูุดุงุก ูุธููุฉ `approve_user()`
- โ ุฅูุดุงุก ูุธููุฉ `reject_user()`
- โ ุฅูุดุงุก ูุธุงุฆู ุงูุชุญูู ูู ุงูุจุฑูุฏ
- โ ุฅุตูุงุญ ุณูุงุณุงุช RLS ูุฌููุน ุงูุฌุฏุงูู
- โ ููุญ ุงูุตูุงุญูุงุช ุงูุตุญูุญุฉ

### ูู ุงูููุฏ (ุชู ุจุงููุนู):
- โ ุฑุจุท ุตูุญุฉ ุงูุฃุฏูู ุจุงูุจูุงูุงุช ุงูุญููููุฉ
- โ ุฅุตูุงุญ ูุธุงุฆู ุงูููุงููุฉ/ุงูุฑูุถ
- โ ุชุญุฏูุซ ุชููุงุฆู ููุจูุงูุงุช ุจุนุฏ ุงูุนูููุงุช
- โ ุฑุณุงุฆู ุฎุทุฃ ููุฌุงุญ ูุงุถุญุฉ ุจุงูุนุฑุจูุฉ

### ูู Edge Functions:
- โ ูุธููุฉ ุฅุฑุณุงู ุงูุจุฑูุฏ ุงูุชุฑุญูุจู
- โ ุฏุนู Resend API
- โ ุชูุงูู ูุน ูุธููุฉ `approve_user()`

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ:

1. **ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:** ูู ูุนูู ุฅูุง ุจุนุฏ ุฅุถุงูุฉ `RESEND_API_KEY`

2. **ุงูุตูุงุญูุงุช:** ุชุฃูุฏ ุฃู ุญุณุงุจ ุงูุฃุฏูู ูุฏูู `role = 'admin'` ูู ุฌุฏูู `user_profiles`

3. **RLS Policies:** ุชู ุฅุตูุงุญูุง ูุชุณูุญ ูููุณุชุฎุฏููู ุงููุฌููููู (anon) ุจุงูุชุณุฌูู

4. **Service Role:** ุฌููุน ุงููุธุงุฆู ููุง ุตูุงุญูุงุช `SECURITY DEFINER` ููุนูู ุจุดูู ุตุญูุญ

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก:

### ูุดููุฉ: "Failed to approve user"
**ุงูุญู:** ุชุญูู ูู:
- ูู ุงูุญุณุงุจ ุงููุณุฌู ุฏุฎููู ูุฏูู role = 'admin'ุ
- ูู ุงููุธููุฉ `approve_user()` ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ

### ูุดููุฉ: "Email not received"
**ุงูุญู:** ุชุญูู ูู:
- ูู RESEND_API_KEY ููุฌูุฏ ูู Secretsุ
- ูู Edge Function `send-notification-email` ูุฑููุนุฉุ
- ูู ุงูุจุฑูุฏ ูู ูุฌูุฏ Spamุ

### ูุดููุฉ: "RLS policy violation"
**ุงูุญู:**
- ุดุบู ุงูุณูุฑูุจุช `FIX_ALL_DATABASE_ISSUES.sql` ูุฑุฉ ุฃุฎุฑู
- ุชุฃูุฏ ูู ููุญ ุงูุตูุงุญูุงุช ูุฌููุน ุงูุฃุฏูุงุฑ (anon, authenticated, service_role)

### ูุดููุฉ: "Function does not exist"
**ุงูุญู:**
- ุดุบู ุงูุณูุฑูุจุช SQL ุงูุฑุฆูุณู
- ุชุญูู ูู Logs ูู Supabase Dashboard

---

## ๐ ุงูุฏุนู:

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:

1. **ุชุญูู ูู Logs:**
   ```
   https://supabase.com/dashboard/project/jtxmijnxrgcwjvtdlgxy/logs/explorer
   ```

2. **ุฑุงุฌุน Browser Console:**
   ุงุถุบุท F12 ูุงุจุญุซ ุนู ุฃุฎุทุงุก

3. **ุชุญูู ูู Network Tab:**
   ููุนุฑูุฉ ุฃู ุทูุจุงุช ูุดูุช

---

## โ ูุงุฆูุฉ ุงูุชุญูู ุงูููุงุฆูุฉ:

- [ ] ุชุดุบูู `FIX_ALL_DATABASE_ISSUES.sql` ุจูุฌุงุญ
- [ ] ุฅุถุงูุฉ `RESEND_API_KEY` ูู Secrets
- [ ] ุฑูุน Edge Function `send-notification-email`
- [ ] ุงุฎุชุจุงุฑ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
- [ ] ุงุฎุชุจุงุฑ ุงูููุงููุฉ ุนูู ูุณุชุฎุฏู ูู ููุญุฉ ุงูุฃุฏูู
- [ ] ุงูุชุญูู ูู ูุตูู ุงูุจุฑูุฏ ุงูุชุฑุญูุจู
- [ ] ุงูุชุญูู ูู ุฅุถุงูุฉ ููุงูุฃุฉ $5 ูููุณุชุฎุฏู

---

**ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ:** 2025-10-30  
**ุงูุฅุตุฏุงุฑ:** 1.0  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุชุทุจูู
